@startuml
!theme plain
hide empty description

' === STATE DEFINITIONS (Matching app_state_t) ===
state STATE_INIT
state STATE_CALIB_SOIL_DRY
state STATE_CALIB_SOIL_WET
state STATE_PROVISIONING
state STATE_WIFI_CONNECT
state STATE_SYNC_TIME
state STATE_SENSING
state STATE_DATA_DECISION
state STATE_MQTT_PUBLISH
state STATE_FLASH_STORE
state STATE_FACTORY_RESET
state STATE_DEEP_SLEEP

' === STARTUP ===
[*] --> STATE_INIT
STATE_INIT --> STATE_SENSING : APP_EVENT_CONFIG_LOADED
STATE_INIT --> STATE_CALIB_SOIL_DRY : APP_EVENT_NO_CONFIG

STATE_CALIB_SOIL_DRY --> STATE_CALIB_SOIL_WET : APP_EVENT_BTN2_SHORT
STATE_CALIB_SOIL_WET --> STATE_PROVISIONING : APP_EVENT_BTN2_SHORT
STATE_CALIB_SOIL_WET --> STATE_CALIB_SOIL_DRY : APP_EVENT_BTN1_SHORT

' === PROVISIONING ===
STATE_PROVISIONING --> STATE_SENSING : APP_EVENT_PROV_DATA_RECVD
STATE_PROVISIONING --> STATE_DEEP_SLEEP : APP_EVENT_PROV_TIMEOUT

' === CONNECTIVITY ===
STATE_WIFI_CONNECT --> STATE_SYNC_TIME : APP_EVENT_WIFI_CONNECTED
STATE_WIFI_CONNECT --> STATE_DATA_DECISION : APP_EVENT_WIFI_DISCONNECTED

STATE_SYNC_TIME --> STATE_DATA_DECISION : APP_EVENT_TIME_SYNC_DONE

' === SENSING ===
STATE_SENSING --> STATE_WIFI_CONNECT : APP_EVENT_SENSORS_DATA_READY

' === DATA HANDLING (Decision Logic) ===
' Note: The decision is internal logic based on wifi status
STATE_DATA_DECISION --> STATE_MQTT_PUBLISH : APP_EVENT_DECISION_MQTT 
STATE_DATA_DECISION --> STATE_FLASH_STORE :  APP_EVENT_DECISION_STORAGE

STATE_MQTT_PUBLISH --> STATE_DEEP_SLEEP : APP_EVENT_MQTT_PUBLISHED
STATE_FLASH_STORE --> STATE_DEEP_SLEEP : APP_EVENT_STORAGE_SAVED


' === WAKEUP & RESET ===
STATE_FACTORY_RESET --> STATE_INIT : APP_EVENT_FACTORY_RESET_DONE
STATE_DEEP_SLEEP --> STATE_INIT : APP_EVENT_BTN1_SHORT 

' === GLOBAL INTERRUPTS ===
' These transitions can happen from active states
state "Global Interrupts" as GI #white ##white {
    state "Any Active State" as ANY
    ANY --> STATE_PROVISIONING : APP_EVENT_BTN1_3S
    ANY --> STATE_FACTORY_RESET : APP_EVENT_BTN1_10S
}

@enduml
